<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hololist</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #00B7EB, #FFFFFF);
            --card-bg: #FFF;
            --text: #333;
            --header-bg: #0288D1;
            --live: #FF0000;
            --upcoming: #00B7EB;
            --shadow: rgba(0, 0, 0, 0.1);
            --border: #00B7EB;
            --announce: #FF6D00;
            --memorial: #FF69B4;
            --check-bg: #4CAF50;
            --clock-bg: rgba(255, 255, 255, 0.95);
            --clock-text: #0288D1;
            --favorite-bg: #FFD700;
            --favorite-border: #FFA000;
            --favorite-card-border: #FFC107;
            --panel-bg: rgba(255,255,255,0.98);
            --modal-bg: rgba(0,0,0,0.7);
            --toggle-btn-bg: #4CAF50;
            --search-bg: #f5f5f5;
            --search-border: #ddd;
        }
        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #0D47A1, #1A1A1A);
            --card-bg: #1E1E1E;
            --text: #EEE;
            --header-bg: #1565C0;
            --live: #E53935;
            --upcoming: #1E88E5;
            --shadow: rgba(0,0,0,0.5);
            --border: #42A5F5;
            --announce: #FF8A65;
            --memorial: #FF8AD4;
            --check-bg: #66BB6A;
            --clock-bg: rgba(30,30,30,0.95);
            --clock-text: #42A5F5;
            --favorite-bg: #FFB300;
            --favorite-border: #FF8F00;
            --favorite-card-border: #FFB300;
            --panel-bg: rgba(30,30,30,0.98);
            --modal-bg: rgba(0,0,0,0.8);
            --toggle-btn-bg: #66BB6A;
            --search-bg: #333;
            --search-border: #555;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 16px;
            color: var(--text);
            min-height: 100vh;
            position: relative;
            padding-bottom: 80px;
        }
        .clock {
            position: fixed; top: 12px; left: 12px;
            background: var(--clock-bg); padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow); font-size: 0.95rem; font-weight: bold;
            color: var(--clock-text); z-index: 1000; border: 1px solid var(--border);
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: var(--panel-bg);
            border-radius: 12px; box-shadow: 0 4px 20px var(--shadow); padding: 16px;
        }
        .logo-img {
            width: 100%;
            max-width: 600px;
            height: auto;
            display: block;
            margin: 0 auto 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        .controls {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
            margin-bottom: 16px; font-size: 0.9rem;
        }
        button {
            padding: 10px 14px; background: var(--header-bg); color: white;
            border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            min-width: 80px; white-space: nowrap;
        }
        button:hover, button:active { background: #0277BD; }
        .tab-button { background: #E0E0E0; color: #333; font-weight: 500; }
        .tab-button.active { background: var(--header-bg); color: white; }
        [data-theme="dark"] .tab-button { background: #333; color: #EEE; }
        .filter-announce { background: var(--announce) !important; color: white !important; }
        .filter-memorial { background: var(--memorial) !important; color: white !important; }
        .filter-checked { background: var(--check-bg) !important; color: white !important; }
        .filter-favorite { background: var(--favorite-bg) !important; color: #000 !important; }
        #toggleCheckedBtn {
            position: fixed; right: 16px; bottom: 16px; z-index: 998;
            background: var(--toggle-btn-bg); color: white; padding: 12px 16px;
            border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
            cursor: pointer; transition: all 0.3s;
        }
        #toggleCheckedBtn:hover { transform: scale(1.05); }
        #toggleCheckedBtn .count {
            background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;
        }
        .search-bar {
            padding: 8px 12px;
            border: 1px solid var(--search-border);
            border-radius: 6px;
            background: var(--search-bg);
            color: var(--text);
            font-size: 0.9rem;
            width: 100%;
            max-width: 300px;
        }
        .search-bar::placeholder { color: #999; }
        .time-group { margin-bottom: 20px; }
        .time-header {
            font-size: 1.1rem; font-weight: bold; color: #FFF; background: var(--header-bg);
            padding: 10px 12px; border-radius: 6px; display: flex;
            align-items: center; justify-content: space-between;
        }
        .header-checkbox {
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
            background: rgba(255,255,255,0.3); border: 2px solid rgba(255,255,255,0.6);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: all 0.2s;
        }
        .header-checkbox.checked { background: var(--check-bg); border-color: var(--check-bg); }
        .schedule-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px; padding: 8px 0;
        }
        .stream-card {
            background: var(--card-bg); border-radius: 10px; overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow); position: relative;
            border: 2px solid transparent; transition: transform 0.2s, border 0.2s;
            display: flex; flex-direction: column;
        }
        .stream-card.favorite { border-color: var(--favorite-card-border) !important; }
        .stream-card:active { transform: scale(0.98); }
        .thumbnail-wrapper { position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; }
        .thumbnail { width: 100%; height: 100%; object-fit: cover; }
        .checkbox-overlay, .favorite-overlay {
            position: absolute; width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s; top: 8px;
        }
        .checkbox-overlay { right: 8px; background: rgba(255,255,255,0.4); border: 3px solid rgba(255,255,255,0.7); }
        .checkbox-overlay.checked { background: var(--check-bg); border-color: var(--check-bg); }
        .favorite-overlay {
            left: 8px; background: rgba(255,255,255,0.5); border: 3px solid var(--favorite-border);
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .favorite-overlay::before {
            content: ''; /* 文字なし */
        }
        .favorite-overlay.favorited {
            background: var(--favorite-bg);
        }
        .favorite-overlay.favorited::before {
            content: '★';
            color: white;
        }
        .stream-info { padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .member-name { font-size: 1.05rem; font-weight: bold; color: var(--header-bg); margin-bottom: 4px; }
        .stream-title { font-size: 0.9rem; color: #555; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex: 1; }
        [data-theme="dark"] .stream-title { color: #CCC; }
        .status-indicator {
            position: absolute; bottom: 8px; right: 8px; padding: 4px 10px;
            border-radius: 6px; color: white; font-size: 0.8rem; font-weight: bold;
        }
        .live { background: var(--live); }
        .upcoming { background: var(--upcoming); }
        .announce { background: var(--announce); }
        .memorial { background: var(--memorial); }
        #checkedPanel {
            position: fixed; bottom: 80px; right: 16px; width: 340px; background: var(--panel-bg);
            border: 2px solid var(--check-bg); border-radius: 12px; padding: 16px;
            z-index: 997; box-shadow: 0 8px 25px rgba(0,0,0,0.3); max-height: 60vh;
            overflow-y: auto; transform: translateX(120%); transition: transform 0.3s ease;
            display: none;
        }
        #checkedPanel.show {
            transform: translateX(0); display: block;
        }
        #checkedPanel .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; font-weight: bold; color: var(--check-bg); font-size: 1.1rem;
        }
        #checkedList > div {
            margin: 6px 0; padding: 10px; background: rgba(76,175,80,0.1);
            border-radius: 8px; font-size: 0.9rem;
        }
        #linkModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 1001; display: none;
            align-items: center; justify-content: center; padding: 16px;
        }
        #linkModal.show { display: flex; }
        .modal-content {
            background: var(--panel-bg); border-radius: 12px; width: 100%;
            max-width: 500px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3); padding: 16px;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; font-weight: bold; font-size: 1.1rem;
        }
        #linkOutput {
            background: #f8f9fa; color: #000; padding: 12px; border-radius: 6px;
            font-family: |monospace; white-space: pre-wrap; font-size: 0.85rem;
            border: 1px solid #ddd; max-height: 300px; overflow-y: auto;
        }
        [data-theme="dark"] #linkOutput { background: #333; color: #EEE; border-color: #555; }
        #toast-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column; gap: 10px;
            align-items: center; max-width: 90vw;
        }
        .notification-toast {
            min-width: 280px; max-width: 380px; background: #1E1E1E; color: #FFF;
            border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.4); padding: 14px;
            font-family: 'Segoe UI','Noto Sans JP',sans-serif; border-left: 4px solid #00B7EB;
            opacity: 0; transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.25,0.8,0.25,1);
        }
        .notification-toast.show { opacity: 1; transform: translateY(0); }
        .notification-toast.live { border-left-color: #E53935; }
        .notification-toast .close-btn {
            position: absolute; top: 6px; right: 10px; background: none; border: none;
            color: #AAA; font-size: 18px; cursor: pointer; padding: 0;
        }
        .notification-toast .title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .notification-toast .body { font-size: 13px; line-height: 1.4; color: #DDD; }
        @media (max-width: 480px) {
            #toggleCheckedBtn { right: 12px; bottom: 12px; padding: 10px 14px; font-size: 0.85rem; }
            #checkedPanel { width: calc(100% - 32px); right: 16px; }
            .search-bar { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="clock" id="jstClock">JST: 00:00:00</div>
    <div id="toggleCheckedBtn" onclick="toggleCheckedPanel()">
        <span>チェック済み</span>
        <span class="count" id="checkedCount">0</span>
    </div>
    <div id="checkedPanel">
        <div class="header">
            <span>チェック済み配信</span>
            <button onclick="toggleCheckedPanel()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#AAA;">x</button>
        </div>
        <div id="checkedList"></div>
        <button onclick="openLinkModal()" style="width:100%; padding:12px; background:#4CAF50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.95rem;">
            配信リンクまとめを作成
        </button>
    </div>
    <div id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>同時視聴リンク</span>
                <button onclick="closeLinkModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#AAA;">x</button>
            </div>
            <div id="linkOutput"></div>
            <button onclick="copyToClipboard()" id="copyBtn" style="width:100%; margin-top:12px; padding:12px; background:#2196F3; color:white; border:none; border-radius:8px; cursor:pointer; font-size:0.95rem;">
                コピーする
            </button>
        </div>
    </div>
    <div id="toast-container"></div>
    <div class="container">
        <h1 style="margin:0;padding:0;text-align:center;">
            <img src="https://drive.google.com/thumbnail?id=1L0g9BOCy2OkCuPPqZP1LoqeXQKP-OhRJ&sz=w1200"
                 alt="hololist"
                 class="logo-img">
        </h1>
        <div class="controls">
            <button onclick="loadSchedule()">更新</button>
            <button onclick="toggleTheme()" id="themeBtn">ダークモード</button>
            <input type="text" id="searchInput" class="search-bar" placeholder="タイトル・メンバー名で検索...">
            <span style="display:flex;align-items:center;gap:4px;font-size:0.9rem;">
                自動更新: <span id="timer">5:00</span>
            </span>
        </div>
        <div class="controls">
            <button class="tab-button active" data-mode="all">すべて</button>
            <button class="tab-button filter-announce" data-mode="announce">告知枠</button>
            <button class="tab-button filter-memorial" data-mode="memorial">記念枠</button>
            <button class="tab-button filter-checked" data-mode="checked">チェック済み</button>
            <button class="tab-button filter-favorite" id="favoriteFilterBtn">推しのみ OFF</button>
            <button class="tab-button" onclick="clearAllChecks()">全チェック解除</button>
        </div>
        <div id="content">読み込み中...</div>
    </div>
    <script>
        const API_KEY = 'ffae7804-5730-4ec9-9931-1d31cc52b9d2';
        const CHECKED_STORAGE = 'hololive_checked_videos';
        const FAVORITE_CHANNELS_STORAGE = 'hololive_favorite_channels';
        let checkedVideos = new Set(JSON.parse(localStorage.getItem(CHECKED_STORAGE) || '[]'));
        let favoriteChannels = new Set(JSON.parse(localStorage.getItem(FAVORITE_CHANNELS_STORAGE) || '[]'));
        let countdown = 300;
        let autoRefreshTimer;
        let currentMode = 'all';
        let isFavoriteFilterActive = false;
        let searchText = '';
        const ANNOUNCE_KEYWORDS = ['告知', 'お披露目', '発表', '新衣装', '続報', '重大', 'おひろめ'];
        const MEMORIAL_KEYWORDS = ['周年', '生誕', '爆誕'];
        let notifyEnabled = localStorage.getItem('notifyEnabled') !== 'false';
        const toastContainer = document.getElementById('toast-container');

        function updateJSTClock() {
            const now = new Date();
            const jst = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
            const h = String(jst.getHours()).padStart(2, '0');
            const m = String(jst.getMinutes()).padStart(2, '0');
            const s = String(jst.getSeconds()).padStart(2, '0');
            document.getElementById('jstClock').textContent = `JST: ${h}:${m}:${s}`;
        }
        updateJSTClock();
        setInterval(updateJSTClock, 1000);

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeBtn').textContent = isDark ? 'ダークモード' : 'ライトモード';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').textContent = 'ライトモード';
        }

        function startAutoRefresh() {
            clearInterval(autoRefreshTimer);
            countdown = 300;
            autoRefreshTimer = setInterval(() => {
                countdown--;
                const m = String(Math.floor(countdown / 60)).padStart(2, '0');
                const s = String(countdown % 60).padStart(2, '0');
                document.getElementById('timer').textContent = `${m}:${s}`;
                if (countdown <= 0) loadSchedule();
            }, 1000);
        }

        function updateCheckedPanel() {
            const list = document.getElementById('checkedList');
            const countEl = document.getElementById('checkedCount');
            const checked = document.querySelectorAll('.checkbox-overlay.checked');
            const count = checked.length;
            countEl.textContent = count;
            if (count === 0) {
                list.innerHTML = '<p style="text-align:center;color:#999;font-size:0.9rem;">チェックなし</p>';
                return;
            }
            let html = '';
            checked.forEach(el => {
                const card = el.closest('.stream-card');
                if (!card) return;
                const member = card.querySelector('.member-name')?.textContent || 'Unknown';
                const title = card.querySelector('.stream-title')?.textContent || '';
                const time = new Date(parseInt(card.dataset.startTime)).toLocaleString('ja-JP', {hour:'2-digit', minute:'2-digit'});
                html += `<div><strong>${member}</strong><br><small>${time} ~ ${title.slice(0,25)}${title.length>25?'...':''}</small></div>`;
            });
            list.innerHTML = html;
        }

        function toggleCheckedPanel() {
            const panel = document.getElementById('checkedPanel');
            const isShown = panel.classList.contains('show');
            if (isShown) {
                panel.classList.remove('show');
                setTimeout(() => panel.style.display = 'none', 300);
            } else {
                updateCheckedPanel();
                panel.style.display = 'block';
                setTimeout(() => panel.classList.add('show'), 10);
            }
        }

        function updateHeaderCheckboxes() {
            document.querySelectorAll('.time-group').forEach(group => {
                const cards = group.querySelectorAll('.stream-card');
                const headerCheck = group.querySelector('.header-checkbox');
                if (!headerCheck || cards.length === 0) return;
                const videoIds = Array.from(cards).map(c => c.dataset.videoId);
                const allChecked = videoIds.every(id => checkedVideos.has(id));
                const someChecked = videoIds.some(id => checkedVideos.has(id));
                headerCheck.classList.toggle('checked', allChecked || someChecked);
                if (someChecked && !allChecked) {
                    headerCheck.style.background = 'linear-gradient(to right, var(--check-bg) 50%, rgba(255,255,255,0.3) 50%)';
                } else {
                    headerCheck.style.background = allChecked ? 'var(--check-bg)' : 'rgba(255,255,255,0.3)';
                }
            });
        }

        function toggleTimeGroupCheck(timeKey, el) {
            event.stopPropagation();
            const group = el.closest('.time-group');
            const cards = group.querySelectorAll('.stream-card');
            const videoIds = Array.from(cards).map(c => c.dataset.videoId);
            const allChecked = videoIds.every(id => checkedVideos.has(id));
            const newState = !allChecked;
            videoIds.forEach(id => {
                if (newState) checkedVideos.add(id);
                else checkedVideos.delete(id);
            });
            localStorage.setItem(CHECKED_STORAGE, JSON.stringify([...checkedVideos]));
            cards.forEach(card => {
                const overlay = card.querySelector('.checkbox-overlay');
                if (overlay) overlay.classList.toggle('checked', newState);
            });
            updateCheckedPanel();
            updateHeaderCheckboxes();
            applyFilter(currentMode);
        }

        function openLinkModal() {
            const checked = document.querySelectorAll('.checkbox-overlay.checked');
            if (checked.length === 0) return alert('チェックがありません！');
            const title = prompt('タイトルを入力（空欄OK）', '');
            if (title === null) return;
            const viewText = prompt('例：視点 / 配信 / 枠 / 部屋 (空欄OK)', '');
            if (viewText === null) return;
            const view = viewText.trim() || '';
            const groups = {};
            checked.forEach(el => {
                const card = el.closest('.stream-card');
                const videoId = card.dataset.videoId;
                const url = `https://youtu.be/${videoId}`;
                const member = card.querySelector('.member-name').textContent;
                const date = new Date(parseInt(card.dataset.startTime));
                const key = date.toLocaleDateString('ja-JP', {
                    month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                }).replace(/\/(\d)\//g, '/0$1/');
                if (!groups[key]) groups[key] = [];
                groups[key].push({member, url});
            });
            let output = title ? `【${title}】\n\n` : '';
            Object.keys(groups).sort().forEach(time => {
                groups[time].forEach(item => {
                    output += `■${time} ~ ${item.member}${view}\n${item.url}\n\n`;
                });
            });
            document.getElementById('linkOutput').textContent = output.trim();
            document.getElementById('linkModal').classList.add('show');
        }

        function closeLinkModal() {
            document.getElementById('linkModal').classList.remove('show');
        }

        function copyToClipboard() {
            const text = document.getElementById('linkOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyBtn');
                const orig = btn.textContent;
                btn.textContent = 'コピー完了！';
                btn.style.background = '#4CAF50';
                setTimeout(() => {
                    btn.textContent = orig;
                    btn.style.background = '#2196F3';
                }, 1500);
            });
        }

        function toggleCheck(id, el) {
            event.stopPropagation();
            const has = checkedVideos.has(id);
            if (has) checkedVideos.delete(id);
            else checkedVideos.add(id);
            el.classList.toggle('checked', !has);
            localStorage.setItem(CHECKED_STORAGE, JSON.stringify([...checkedVideos]));
            updateCheckedPanel();
            updateHeaderCheckboxes();
            applyFilter(currentMode);
        }

        function clearAllChecks() {
            if (!confirm('すべて解除しますか？')) return;
            checkedVideos.clear();
            localStorage.setItem(CHECKED_STORAGE, '[]');
            document.querySelectorAll('.checkbox-overlay').forEach(el => el.classList.remove('checked'));
            updateCheckedPanel();
            updateHeaderCheckboxes();
            applyFilter(currentMode);
        }

        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchText = this.value.toLowerCase().trim();
                applyFilter(currentMode);
            }, 300);
        });

        function applyFilter(mode = 'all') {
            currentMode = mode;
            document.querySelectorAll('.time-group').forEach(group => {
                const cards = group.querySelectorAll('.stream-card');
                let visibleCount = 0;
                cards.forEach(card => {
                    const videoId = card.dataset.videoId;
                    const channelId = card.dataset.channelId;
                    const title = card.querySelector('.stream-title').textContent.toLowerCase();
                    const member = card.querySelector('.member-name').textContent.toLowerCase();
                    const isAnnounce = ANNOUNCE_KEYWORDS.some(kw => title.includes(kw.toLowerCase()));
                    const isMemorial = MEMORIAL_KEYWORDS.some(kw => title.includes(kw.toLowerCase()));
                    const isChecked = checkedVideos.has(videoId);
                    const isFavorite = favoriteChannels.has(channelId);
                    const matchesSearch = !searchText || title.includes(searchText) || member.includes(searchText);
                    let show = matchesSearch;
                    if (isFavoriteFilterActive && !isFavorite) show = false;
                    if (mode === 'announce' && !isAnnounce) show = false;
                    if (mode === 'memorial' && !isMemorial) show = false;
                    if (mode === 'checked' && !isChecked) show = false;
                    card.style.display = show ? 'flex' : 'none';
                    if (show) visibleCount++;
                });
                group.style.display = visibleCount > 0 ? 'block' : 'none';
            });
        }

        document.querySelectorAll('.tab-button[data-mode]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button[data-mode]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                isFavoriteFilterActive = false;
                document.getElementById('favoriteFilterBtn').textContent = '推しのみ OFF';
                document.getElementById('favoriteFilterBtn').classList.remove('active');
                applyFilter(btn.dataset.mode);
            });
        });

        document.getElementById('favoriteFilterBtn').addEventListener('click', () => {
            isFavoriteFilterActive = !isFavoriteFilterActive;
            document.getElementById('favoriteFilterBtn').textContent = `推しのみ ${isFavoriteFilterActive ? 'ON' : 'OFF'}`;
            document.getElementById('favoriteFilterBtn').classList.toggle('active', isFavoriteFilterActive);
            applyFilter(currentMode);
        });

        async function loadSchedule() {
            const content = document.getElementById('content');
            content.innerHTML = '<p class="loading">読み込み中...</p>';
            try {
                const res = await fetch('https://holodex.net/api/v2/live?org=Hololive&status=live,upcoming&limit=100', {
                    headers: { 'X-APIKEY': API_KEY }
                });
                if (!res.ok) throw new Error('APIエラー: ' + res.status);
                const videos = await res.json();
                const groups = {};
                videos.forEach(v => {
                    const d = new Date(v.available_at);
                    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:00`;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(v);
                });
                let html = '';
                Object.keys(groups).sort().forEach(k => {
                    html += `
                    <div class="time-group">
                        <div class="time-header">
                            <span>${k}</span>
                            <div class="header-checkbox" onclick="toggleTimeGroupCheck('${k}', this)"></div>
                        </div>
                        <div class="schedule-container">`;
                    groups[k].forEach(v => {
                        const cid = v.channel?.id || 'unknown';
                        const cname = v.channel?.name || 'Unknown';
                        const isMember = v.channel?.org === 'Hololive';
                        const checked = checkedVideos.has(v.id) ? 'checked' : '';
                        const fav = favoriteChannels.has(cid) ? 'favorited' : '';
                        const startMs = new Date(v.available_at).getTime();
                        const thumb = `https://img.youtube.com/vi/${v.id}/hqdefault.jpg`;
                        const timeStr = new Date(v.available_at).toLocaleString('ja-JP', {hour:'2-digit', minute:'2-digit'});
                        const isAnn = ANNOUNCE_KEYWORDS.some(kw => v.title.includes(kw));
                        const isMem = MEMORIAL_KEYWORDS.some(kw => v.title.includes(kw));
                        const stClass = isMem ? 'memorial' : (isAnn ? 'announce' : (v.status === 'live' ? 'live' : 'upcoming'));
                        const stText = isMem ? '記念' : (isAnn ? '告知' : (v.status === 'live' ? 'LIVE' : timeStr));
                        html += `
                        <div class="stream-card ${fav?'favorite':''}" data-video-id="${v.id}" data-channel-id="${cid}" data-start-time="${startMs}">
                            <div class="thumbnail-wrapper">
                                <a href="https://youtu.be/${v.id}" target="_blank">
                                    <img src="${thumb}" class="thumbnail" onerror="this.src='https://via.placeholder.com/280x158/333/FFF?text=No+Image'">
                                </a>
                                <div class="checkbox-overlay ${checked}" onclick="event.stopPropagation(); toggleCheck('${v.id}', this)"></div>
                                ${isMember ? `<div class="favorite-overlay ${fav}" onclick="event.stopPropagation(); toggleFavorite('${cid}', this)"></div>` : ''}
                            </div>
                            <div class="stream-info">
                                <div class="member-name">${cname}</div>
                                <div class="stream-title">${v.title}</div>
                            </div>
                            <div class="status-indicator ${stClass}">${stText}</div>
                        </div>`;
                    });
                    html += `</div></div>`;
                });
                content.innerHTML = html || '<p class="no-streams">配信予定なし</p>';
                updateCheckedPanel();
                updateHeaderCheckboxes();
                applyFilter(currentMode);
                startAutoRefresh();
            } catch (e) {
                content.innerHTML = `<p class="error">読み込み失敗: ${e.message}</p>`;
            }
        }

        function toggleFavorite(id, el) {
            event.stopPropagation();
            const has = favoriteChannels.has(id);
            if (has) favoriteChannels.delete(id);
            else favoriteChannels.add(id);
            el.classList.toggle('favorited', !has);
            localStorage.setItem(FAVORITE_CHANNELS_STORAGE, JSON.stringify([...favoriteChannels]));
            document.querySelectorAll(`.stream-card[data-channel-id="${id}"]`).forEach(c => {
                c.classList.toggle('favorite', !has);
            });
            applyFilter(currentMode);
        }

        function showToast(message, isLive = false) {
            if ([...toastContainer.children].some(t => t.querySelector('.body')?.textContent === message)) return;
            const toast = document.createElement('div');
            toast.className = `notification-toast ${isLive ? 'live' : ''}`;
            toast.innerHTML = `
                <button class="close-btn" onclick="closeToast(this)">x</button>
                <div class="title">${isLive ? '配信開始！' : 'あと5分'}</div>
                <div class="body">${message}</div>
            `;
            toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            const timer = setTimeout(() => closeToast(toast.querySelector('.close-btn')), 600000);
            toast.dataset.timer = timer;
        }

        function closeToast(btn) {
            const toast = btn.parentElement;
            clearTimeout(toast.dataset.timer);
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 400);
        }

        function checkNotifications() {
            if (!notifyEnabled) return;
            const now = Date.now();
            document.querySelectorAll('.stream-card').forEach(card => {
                const start = parseInt(card.dataset.startTime);
                const diff = start - now;
                const member = card.querySelector('.member-name').textContent;
                const title = card.querySelector('.stream-title').textContent;
                const isChecked = card.querySelector('.checkbox-overlay.checked');
                const isFavorite = favoriteChannels.has(card.dataset.channelId);
                if (!isChecked && !isFavorite) return;
                const message = `${member} - ${title}`;
                if (diff > -30000 && diff <= 30000 && !card.dataset.liveNotified) {
                    card.dataset.liveNotified = "true";
                    showToast(message, true);
                }
                if (diff > 240000 && diff <= 300000 && !card.dataset.fiveMinNotified) {
                    card.dataset.fiveMinNotified = "true";
                    showToast(message, false);
                }
            });
        }

        const notifyBtn = document.createElement('button');
        notifyBtn.textContent = `通知: ${notifyEnabled?'ON':'OFF'}`;
        notifyBtn.style.background = notifyEnabled ? '#FF9800' : '#666';
        notifyBtn.style.fontSize = '0.9rem';
        notifyBtn.onclick = () => {
            notifyEnabled = !notifyEnabled;
            notifyBtn.textContent = `通知: ${notifyEnabled?'ON':'OFF'}`;
            notifyBtn.style.background = notifyEnabled ? '#FF9800' : '#666';
            localStorage.setItem('notifyEnabled', notifyEnabled);
        };
        document.querySelectorAll('.controls')[0].appendChild(notifyBtn);
        setInterval(checkNotifications, 10000);

        window.onload = () => {
            loadSchedule();
            startAutoRefresh();
            checkNotifications();
            updateCheckedPanel();
        };
    </script>
</body>
</html>
