<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hololist</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #00B7EB, #FFFFFF);
            --card-bg: #FFF;
            --text: #333;
            --header-bg: #0288D1;
            --live: #FF0000;
            --upcoming: #00B7EB;
            --shadow: rgba(0, 0, 0, 0.1);
            --border: #00B7EB;
            --announce: #FF6D00;
            --memorial: #FF69B4;
            --check-bg: #4CAF50;
            --check-border: #43A047;
            --all-check-bg: #4FC3F7;
            --clock-bg: rgba(255, 255, 255, 0.95);
            --clock-text: #0288D1;
            --favorite-bg: #FFD700;
            --favorite-border: #FFA000;
            --favorite-card-border: #FFC107;
            --error: #E53935;
        }
        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #0D47A1, #1A1A1A);
            --card-bg: #1E1E1E;
            --text: #EEE;
            --header-bg: #1565C0;
            --live: #E53935;
            --upcoming: #1E88E5;
            --shadow: rgba(0,0,0,0.5);
            --border: #42A5F5;
            --announce: #FF8A65;
            --memorial: #FF8AD4;
            --check-bg: #66BB6A;
            --check-border: #4CAF50;
            --all-check-bg: #81D4FA;
            --clock-bg: rgba(30,30,30,0.95);
            --clock-text: #42A5F5;
            --favorite-bg: #FFB300;
            --favorite-border: #FF8F00;
            --favorite-card-border: #FFB300;
            --error: #EF5350;
        }
        body {font-family:'Noto Sans JP',sans-serif;background:var(--bg-gradient);margin:0;padding:15px 8px;color:var(--text);min-height:100vh;box-sizing:border-box;}
        .clock {position:fixed;top:10px;right:10px;background:var(--clock-bg);padding:8px 12px;border-radius:8px;box-shadow:0 2px 10px var(--shadow);font-weight:bold;color:var(--clock-text);z-index:1000;font-size:14px;border:1px solid var(--border);}
        .container {max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.98);border-radius:12px;box-shadow:0 4px 20px var(--shadow);padding:15px;}
        [data-theme="dark"] .container {background:rgba(30,30,30,0.98);}
        .logo-img {width:100%;max-width:600px;height:auto;display:block;margin:0 auto 15px;border-radius:8px;box-shadow:0 2px 8px var(--shadow);}
        .controls {display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:15px;align-items:center;}
        button {padding:8px 14px;background:var(--header-bg);color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;}
        button:hover {opacity:0.9;}
        .search-bar {padding:10px 12px;border:1px solid #ccc;border-radius:6px;width:100%;max-width:300px;font-size:15px;box-sizing:border-box;}
        [data-theme="dark"] .search-bar {background:#333;color:#EEE;border-color:#555;}
        .summary {text-align:center;font-size:1.15em;margin:15px 0;color:var(--header-bg);font-weight:bold;}
        .filter-controls {display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:20px;}
        .filter-checkbox {display:flex;align-items:center;padding:8px 14px;background:#f0f0f0;color:#333;border-radius:30px;cursor:pointer;user-select:none;font-weight:bold;font-size:14px;transition:all .2s;}
        [data-theme="dark"] .filter-checkbox {background:#333;color:#EEE;}
        .filter-checkbox input {position:absolute;opacity:0;}
        .filter-checkbox .checkmark {
            width:22px;height:22px;
            background:rgba(255,255,255,0.3);border:2px solid rgba(255,255,255,0.6);
            border-radius:50%;margin-right:8px;transition:all .2s;
        }
        .filter-checkbox input:checked ~ .checkmark {
            background:var(--check-bg);border-color:var(--check-bg);
        }
        .filter-checkbox[data-mode="all"] input:checked ~ .checkmark {background:var(--all-check-bg);border-color:var(--all-check-bg);}
        .filter-checkbox[data-mode="announce"] input:checked ~ .checkmark {background:var(--announce);border-color:var(--announce);}
        .filter-checkbox[data-mode="memorial"] input:checked ~ .checkmark {background:var(--memorial);border-color:var(--memorial);}
        #favoriteFilterBtn input:checked ~ .checkmark {background:var(--favorite-bg);border-color:var(--favorite-bg);}
        .filter-checkbox.active {background:var(--header-bg);color:white;}
        .clear-all-btn {background:#ddd;color:#333;padding:8px 16px;border-radius:30px;font-size:14px;}
        [data-theme="dark"] .clear-all-btn {background:#444;color:#EEE;}
        .time-group {margin-bottom:28px;}
        .time-header {font-size:1.2em;font-weight:bold;color:#FFF;background:var(--header-bg);padding:12px 15px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
        .header-checkbox {width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,0.3);border:2px solid rgba(255,255,255,0.6);cursor:pointer;transition:all .2s;}
        .header-checkbox.checked {background:var(--check-bg);border-color:var(--check-bg);}
        .schedule-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 16px;
            justify-items: stretch;
            padding: 0 8px;
        }
        @media (max-width: 560px) {
            .schedule-container { grid-template-columns: 1fr; }
        }
        .stream-card {
            width: 100%;
            background:var(--card-bg);
            border-radius:12px;
            overflow:hidden;
            box-shadow:0 4px 12px var(--shadow);
            position:relative;
            border:3px solid transparent;
            transition:transform .2s,box-shadow .2s;
        }
        .stream-card.favorite {border-color:var(--favorite-card-border)!important;}
        .stream-card:hover {transform:translate17Y(-4px);box-shadow:0 8px 20px var(--shadow);}
        .thumbnail {width:100%;aspect-ratio:16/9;object-fit:cover;}
        .stream-info {padding:12px;}
        .member-name {font-size:1.18em;font-weight:bold;color:var(--header-bg);margin-bottom:4px;}
        .stream-title {font-size:0.95em;color:#555;line-height:1.45;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
        [data-theme="dark"] .stream-title {color:#DDD;}
        .status-indicator {
            position:absolute;bottom:12px;right:12px;padding:6px 12px;border-radius:6px;color:white;
            font-size:0.85em;font-weight:bold;
        }
        .live {background:var(--live);}
        .upcoming {background:var(--upcoming);}
        .announce {background:var(--announce);}
        .memorial {background:var(--memorial);}
        /* 告知＋記念の半分割れバッジ */
        .announce-memorial {
            background: linear-gradient(to right, var(--announce) 50%, var(--memorial) 50%);
            font-size:0.75em !important;
            padding:6px 8px;
        }
        .checkbox-overlay {
            position:absolute;top:10px;right:10px;
            width:36px;height:36px;border-radius:50%;
            background:rgba(255,255,255,0.4);border:2px solid rgba(255,255,255,0.6);
            cursor:pointer;z-index:10;
            box-shadow:0 2px 6px rgba(0,0,0,0.3);
            transition:all .2s;
        }
        .checkbox-overlay.checked {
            background:var(--check-bg);
            border-color:var(--check-border);
        }
        .favorite-overlay {
            position:absolute;top:10px;left:10px;
            width:36px;height:36px;border-radius:50%;
            background:rgba(255,255,255,0.5);border:2px solid var(--favorite-border);
            cursor:pointer;z-index:10;
            box-shadow:0 2px 6px rgba(0,0,0,0.3);
            transition:all .2s;
        }
        .favorite-overlay.favorited {
            background:var(--favorite-bg);
            border-color:var(--favorite-bg);
        }
        .error-message {text-align:center;color:var(--error);padding:20px;background:rgba(255,0,0,0.1);border-radius:10px;margin:20px 0;}
        #checkedBottomBar {
            position: fixed;
            bottom: 20px;
            right: 16px;
            background: var(--check-bg);
            color: white;
            padding: 14px 20px;
            border-radius: 14px;
            font-weight: bold;
            font-size: 15px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.35);
            z-index: 998;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            min-width: 200px;
            justify-content: center;
        }
        #checkedBottomBar:active { transform: scale(0.95); }
        #checkedBottomBar::before {content: "Checkmark";font-size: 19px;}
        #checkedPanelNew {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--clock-bg);
            border-top: 4px solid var(--check-bg);
            border-radius: 16px 16px 0 0;
            max-height: 85vh;
            overflow-y: auto;
            padding: 18px;
            z-index: 999;
            box-shadow: 0 -8px 30px rgba(0,0,0,0.4);
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1);
        }
        #checkedPanelNew.open {transform: translateY(0);}
        #checkedPanelNew .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            font-weight: bold;
            font-size: 1.2em;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="clock" id="jstClock">JST: 00:00:00</div>

    <div id="checkedBottomBar" onclick="toggleCheckedPanel()" style="display:none;">
        チェック済みの配信 [<span id="checkedCountBtn">0</span>]
    </div>

    <div id="checkedPanelNew">
        <div class="panel-header">
            <span>チェック済み配信 (<span id="checkedCount">0</span>件)</span>
            <button onclick="document.getElementById('checkedPanelNew').classList.remove('open')" style="background:none;border:none;font-size:28px;cursor:pointer;color:#AAA;">x</button>
        </div>
        <div id="checkedList"></div>
        <button onclick="generateLinkSummary()" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;margin-top:14px;font-size:15px;">配信リンクまとめを作成</button>
        <div id="linkOutput" style="white-space:pre-wrap;margin-top:12px;padding:12px;background:#333;color:#0f0;border-radius:8px;display:none;font-size:14px;"></div>
        <button onclick="copyToClipboard()" id="copyBtn" style="width:100%;margin-top:10px;padding:12px;background:#2196F3;color:white;border:none;border-radius:8px;cursor:pointer;display:none;">コピーする</button>
    </div>

    <div id="toast-container"></div>

    <div class="container">
        <h1 style="margin:0;padding:0;text-align:center;">
            <img src="https://drive.google.com/thumbnail?id=1L0g9BOCy2OkCuPPqZP1LoqeXQKP-OhRJ&sz=w1200" alt="hololist" class="logo-img">
        </h1>
        <div class="controls">
            <button onclick="loadSchedule()">更新</button>
            <button onclick="toggleTheme()" id="themeBtn">ダークモード</button>
            <button onclick="location.href='https://ampere112coulomb.github.io/holoschedule/schedule-by%20ampere.html'"
        style="background:#0288d1;color:white;">PC版</button>
            <input type="text" id="searchInput" class="search-bar" placeholder="タイトル・メンバー名で検索...">
            <span style="margin-left:10px;">自動更新: <span id="timer">5:00</span></span>
        </div>
        <div class="summary" id="summary">今日の配信: <strong id="todayCount">0</strong>本（LIVE: <span id="liveCount">0</span> | 予定: <span id="upcomingCount">0</span>）</div>
        <div class="filter-controls">
            <label class="filter-checkbox active" data-mode="all">
                <input type="checkbox" checked><span class="checkmark"></span><span>すべて</span>
            </label>
            <label class="filter-checkbox" data-mode="announce">
                <input type="checkbox"><span class="checkmark"></span><span>告知枠</span>
            </label>
            <label class="filter-checkbox" data-mode="memorial">
                <input type="checkbox"><span class="checkmark"></span><span>記念枠</span>
            </label>
            <label class="filter-checkbox" data-mode="checked">
                <input type="checkbox"><span class="checkmark"></span><span>チェック済み</span>
            </label>
            <label class="filter-checkbox" id="favoriteFilterBtn">
                <input type="checkbox"><span class="checkmark"></span><span>推しのみ OFF</span>
            </label>
            <button class="clear-all-btn" onclick="clearAllChecks()">全チェック解除</button>
        </div>
        <div id="content">読み込み中...</div>
    </div>

    <script>
        const API_KEY = 'ffae7804-5730-4ec9-9931-1d31cc52b9d2';
        const CHECKED_STORAGE = 'hololive_checked_videos';
        const FAVORITE_CHANNELS_STORAGE = 'hololive_favorite_channels';
        let checkedVideos = new Set(JSON.parse(localStorage.getItem(CHECKED_STORAGE) || '[]'));
        let favoriteChannels = new Set(JSON.parse(localStorage.getItem(FAVORITE_CHANNELS_STORAGE) || '[]'));
        let countdown = 300;
        let autoRefreshTimer;
        const ANNOUNCE_KEYWORDS = ['告知','お披露目','発表','新衣装','重大','おひろめ'];
        const MEMORIAL_KEYWORDS = ['周年','生誕','爆誕'];
        let notifyEnabled = localStorage.getItem('notifyEnabled') !== 'false';
        const toastContainer = document.getElementById('toast-container');

        function updateJSTClock() {
            const now = new Date();
            const jst = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
            const h = String(jst.getHours()).padStart(2, '0');
            const m = String(jst.getMinutes()).padStart(2, '0');
            const s = String(jst.getSeconds()).padStart(2, '0');
            document.getElementById('jstClock').textContent = `JST: ${h}:${m}:${s}`;
        }
        updateJSTClock(); setInterval(updateJSTClock, 1000);

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeBtn').textContent = isDark ? 'ダークモード' : 'ライトモード';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').textContent = 'ライトモード';
        }

        function startAutoRefresh() {
            clearInterval(autoRefreshTimer);
            countdown = 300;
            autoRefreshTimer = setInterval(() => {
                countdown--;
                const m = String(Math.floor(countdown / 60)).padStart(2, '0');
                const s = String(countdown % 60).padStart(2, '0');
                document.getElementById('timer').textContent = `${m}:${s}`;
                if (countdown <= 0) loadSchedule();
            }, 1000);
        }

        function toggleCheckedPanel() {
            document.getElementById('checkedPanelNew').classList.toggle('open');
        }

        function updateCheckedPanel() {
            const checked = document.querySelectorAll('.checkbox-overlay.checked');
            const count = checked.length;
            document.getElementById('checkedCount').textContent = count;
            document.getElementById('checkedCountBtn').textContent = count;
            const bar = document.getElementById('checkedBottomBar');
            bar.style.display = count > 0 ? 'flex' : 'none';
            if (count === 0) {
                document.getElementById('checkedPanelNew').classList.remove('open');
                document.getElementById('linkOutput').style.display = 'none';
                document.getElementById('copyBtn').style.display = 'none';
                document.getElementById('checkedList').innerHTML = '';
                return;
            }
            let html = '';
            checked.forEach(el => {
                const card = el.closest('.stream-card');
                const member = card.querySelector('.member-name').textContent;
                const title = card.querySelector('.stream-title').textContent;
                const time = new Date(parseInt(card.dataset.startTime)).toLocaleString('ja-JP', {hour:'2-digit', minute:'2-digit'});
                html += `<div style="padding:12px 0;border-bottom:1px solid #555;cursor:pointer;"
                         onclick="document.querySelector('.stream-card[data-video-id=\\'${card.dataset.videoId}\\']').scrollIntoView({behavior:'smooth',block:'center'}); toggleCheckedPanel();">
                    <strong>${member}</strong><br>
                    <small>${time} ~ ${title.slice(0,38)}${title.length>38?'...':''}</small>
                </div>`;
            });
            document.getElementById('checkedList').innerHTML = html;
        }

        function updateHeaderCheckboxes() {
            document.querySelectorAll('.time-group').forEach(group => {
                const visibleCards = group.querySelectorAll('.stream-card:not(.force-hidden-check)');
                const headerCheck = group.querySelector('.header-checkbox');
                if (!headerCheck || visibleCards.length === 0) return;
                let checkedCount = 0;
                visibleCards.forEach(card => {
                    if (checkedVideos.has(card.dataset.videoId)) checkedCount++;
                });
                const allChecked = checkedCount === visibleCards.length;
                const someChecked = checkedCount > 0 && !allChecked;
                headerCheck.classList.toggle('checked', allChecked || someChecked);
                if (someChecked) {
                    headerCheck.style.background = 'linear-gradient(to right, var(--check-bg) 50%, rgba(255,255,255,0.3) 50%)';
                } else {
                    headerCheck.style.background = allChecked ? 'var(--check-bg)' : 'rgba(255,255,255,0.3)';
                }
            });
        }

        function toggleTimeGroupCheck(timeKey, el) {
            event.stopPropagation();
            const group = el.closest('.time-group');
            const cards = group.querySelectorAll('.stream-card:not(.force-hidden-check)');
            const videoIds = Array.from(cards).map(c => c.dataset.videoId);
            const allChecked = videoIds.every(id => checkedVideos.has(id));
            if (allChecked) {
                videoIds.forEach(id => checkedVideos.delete(id));
            } else {
                videoIds.forEach(id => checkedVideos.add(id));
            }
            localStorage.setItem(CHECKED_STORAGE, JSON.stringify([...checkedVideos]));
            cards.forEach(card => {
                const overlay = card.querySelector('.checkbox-overlay');
                if (overlay) overlay.classList.toggle('checked', !allChecked);
            });
            updateCheckedPanel();
            updateHeaderCheckboxes();
            applyFilter();
        }

        async function generateLinkSummary() {
            const checked = document.querySelectorAll('.checkbox-overlay.checked');
            if (checked.length === 0) { alert('チェックがありません。'); return; }
            const title = prompt('タイトルを入力（空欄OK）', '');
            if (title === null) return;
            const viewText = prompt('例：視点 / 配信 / 枠 / 部屋 (空欄OK)', '');
            if (viewText === null) return;
            const view = viewText.trim() || '';
            const groups = {};
            checked.forEach(el => {
                const card = el.closest('.stream-card');
                const videoId = card.dataset.videoId;
                const url = `https://youtu.be/${videoId}`;
                const member = card.querySelector('.member-name').textContent;
                const date = new Date(parseInt(card.dataset.startTime));
                const key = date.toLocaleDateString('ja-JP', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}).replace(/\/(\d)\//g, '/0$1/');
                if (!groups[key]) groups[key] = [];
                groups[key].push({member, url});
            });
            let output = title ? `【${title}】\n\n` : '';
            Object.keys(groups).sort().forEach(time => {
                groups[time].forEach(item => {
                    output += `■${time} ~ ${item.member}${view}\n${item.url}\n\n`;
                });
            });
            const outputEl = document.getElementById('linkOutput');
            const copyBtn = document.getElementById('copyBtn');
            outputEl.textContent = output.trim();
            outputEl.style.display = 'block';
            copyBtn.style.display = 'block';
        }

        function copyToClipboard() {
            const text = document.getElementById('linkOutput').textContent;
            const btn = document.getElementById('copyBtn');
            const originalText = btn.textContent;
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'コピー完了！';
                btn.style.background = '#4CAF50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#2196F3';
                }, 1500);
            });
        }

        function toggleCheck(id, el) {
            event.stopPropagation();
            if (checkedVideos.has(id)) {
                checkedVideos.delete(id);
                el.classList.remove('checked');
            } else {
                checkedVideos.add(id);
                el.classList.add('checked');
            }
            localStorage.setItem(CHECKED_STORAGE, JSON.stringify([...checkedVideos]));
            updateCheckedPanel();
            updateHeaderCheckboxes();
            applyFilter();
        }

        function clearAllChecks() {
            if (!confirm('すべて解除しますか？')) return;
            checkedVideos.clear();
            localStorage.setItem(CHECKED_STORAGE, '[]');
            document.querySelectorAll('.checkbox-overlay').forEach(el => el.classList.remove('checked'));
            updateCheckedPanel();
            updateHeaderCheckboxes();
            applyFilter();
        }

        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilter, 300);
        });

        function applyFilter() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const allInput = document.querySelector('.filter-checkbox[data-mode="all"] input');
            const announceInput = document.querySelector('.filter-checkbox[data-mode="announce"] input');
            const memorialInput = document.querySelector('.filter-checkbox[data-mode="memorial"] input');
            const checkedInput = document.querySelector('.filter-checkbox[data-mode="checked"] input');
            const favoriteInput = document.getElementById('favoriteFilterBtn').querySelector('input');
            const filterAll = allInput.checked;
            const filterAnnounce = announceInput.checked;
            const filterMemorial = memorialInput.checked;
            const filterChecked = checkedInput.checked;
            const filterFavorite = favoriteInput.checked;

            document.getElementById('favoriteFilterBtn').querySelector('span:not(.checkmark)').textContent = `推しのみ ${filterFavorite ? 'ON' : 'OFF'}`;
            document.querySelectorAll('.filter-checkbox').forEach(label => {
                label.classList.toggle('active', label.querySelector('input').checked);
            });

            document.querySelectorAll('.time-group').forEach(group => {
                const cards = group.querySelectorAll('.stream-card');
                let visibleCount = 0;
                cards.forEach(card => {
                    const videoId = card.dataset.videoId;
                    const channelId = card.dataset.channelId;
                    const title = card.querySelector('.stream-title').textContent.toLowerCase();
                    const member = card.querySelector('.member-name').textContent.toLowerCase();
                    const isAnnounce = ANNOUNCE_KEYWORDS.some(kw => title.includes(kw.toLowerCase()));
                    const isMemorial = MEMORIAL_KEYWORDS.some(kw => title.includes(kw.toLowerCase()));
                    const isChecked = checkedVideos.has(videoId);
                    const isFavorite = favoriteChannels.has(channelId);
                    const matchesSearch = !searchText || title.includes(searchText) || member.includes(searchText);
                    let show = matchesSearch;
                    if (!filterAll) {
                        if (filterAnnounce && !isAnnounce) show = false;
                        if (filterMemorial && !isMemorial) show = false;
                        if (filterChecked && !isChecked) show = false;
                    }
                    if (filterFavorite && !isFavorite) show = false;
                    card.style.display = show ? 'block' : 'none';
                    if (show) {
                        card.classList.remove('force-hidden-check');
                        visibleCount++;
                    } else {
                        card.classList.add('force-hidden-check');
                    }
                });
                group.style.display = visibleCount > 0 ? 'block' : 'none';
            });
            updateSummary();
            updateHeaderCheckboxes();
        }

        document.querySelectorAll('.filter-checkbox input').forEach(input => {
            input.addEventListener('change', function() {
                const mode = this.parentElement.dataset.mode;
                if (mode === 'all' && this.checked) {
                    document.querySelectorAll('.filter-checkbox input').forEach(cb => { if (cb !== this) cb.checked = false; });
                } else if (mode !== 'all') {
                    document.querySelector('.filter-checkbox[data-mode="all"] input').checked = false;
                }
                applyFilter();
            });
        });

        async function loadSchedule() {
            const content = document.getElementById('content');
            content.innerHTML = '<p style="text-align:center;padding:40px;">読み込み中...</p>';
            try {
                const res = await fetch('https://holodex.net/api/v2/live?org=Hololive&status=live,upcoming&limit=100', {
                    headers: { 'X-APIKEY': API_KEY }
                });
                if (!res.ok) throw new Error(res.status === 429 ? 'リクエスト多すぎ（しばらく待ってね）' : '読み込み失敗');
                const videos = await res.json();
                if (!Array.isArray(videos)) throw new Error('データ形式エラー');
                const groups = {};
                videos.forEach(v => {
                    const d = new Date(v.available_at);
                    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:00`;
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(v);
                });
                let html = '';
                Object.keys(groups).sort().forEach(k => {
                    html += `
                    <div class="time-group">
                        <div class="time-header">
                            <span>${k.replace(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):00/, '$1/$2/$3 $4:00')}</span>
                            <div class="header-checkbox" onclick="toggleTimeGroupCheck('${k}', this)"></div>
                        </div>
                        <div class="schedule-container">`;
                    groups[k].forEach(v => {
                        const cid = v.channel?.id || 'unknown';
                        const cname = v.channel?.name || 'Unknown';
                        const checked = checkedVideos.has(v.id) ? 'checked' : '';
                        const fav = favoriteChannels.has(cid) ? 'favorited' : '';
                        const startMs = new Date(v.available_at).getTime();
                        const thumb = `https://img.youtube.com/vi/${v.id}/hqdefault.jpg`;
                        const timeStr = new Date(v.available_at).toLocaleString('ja-JP', {hour:'2-digit', minute:'2-digit'});

                        const isAnn = ANNOUNCE_KEYWORDS.some(kw => v.title.includes(kw));
                        const isMem = MEMORIAL_KEYWORDS.some(kw => v.title.includes(kw));

                        let stClass = 'upcoming';
                        let stText = timeStr;  // デフォルトは時間表示

                        if (v.status === 'live') {
                            stClass = 'live';
                            stText = 'LIVE';
                        } else if (isAnn && isMem) {
                            stClass = 'announce-memorial';
                        } else if (isAnn) {
                            stClass = 'announce';
                        } else if (isMem) {
                            stClass = 'memorial';
                        }

                        html += `
                        <div class="stream-card ${fav?'favorite':''}" data-video-id="${v.id}" data-channel-id="${cid}" data-start-time="${startMs}">
                            <div style="position:relative;">
                                <a href="https://youtu.be/${v.id}" target="_blank">
                                    <img src="${thumb}" class="thumbnail" onerror="this.src='https://via.placeholder.com/280x158/333/FFF?text=No+Image'">
                                </a>
                                <div class="checkbox-overlay ${checked}" onclick="event.stopPropagation();toggleCheck('${v.id}', this)"></div>
                                ${v.channel?.org === 'Hololive' ? `<div class="favorite-overlay ${fav}" onclick="event.stopPropagation();toggleFavorite('${cid}', this)"></div>` : ''}
                            </div>
                            <div class="stream-info">
                                <div class="member-name">${cname}</div>
                                <div class="stream-title">${v.title}</div>
                            </div>
                            <div class="status-indicator ${stClass}">${stText}</div>
                        </div>`;
                    });
                    html += `</div></div>`;
                });
                content.innerHTML = html || '<p style="text-align:center;color:#666;">今日の配信予定はありません</p>';
                applyFilter();
                updateSummary();
                updateHeaderCheckboxes();
                updateCheckedPanel();
                startAutoRefresh();
            } catch (e) {
                content.innerHTML = `<div class="error-message"><strong>読み込み失敗</strong><p>${e.message}</p><small>【更新】ボタンで再試行</small></div>`;
            }
        }

        function updateSummary() {
            const live = document.querySelectorAll('.status-indicator.live').length;
            const upcoming = document.querySelectorAll('.status-indicator:not(.live)').length;
            document.getElementById('todayCount').textContent = live + upcoming;
            document.getElementById('liveCount').textContent = live;
            document.getElementById('upcomingCount').textContent = upcoming;
        }

        function toggleFavorite(id, el) {
            event.stopPropagation();
            if (favoriteChannels.has(id)) {
                favoriteChannels.delete(id);
                el.classList.remove('favorited');
            } else {
                favoriteChannels.add(id);
                el.classList.add('favorited');
            }
            localStorage.setItem(FAVORITE_CHANNELS_STORAGE, JSON.stringify([...favoriteChannels]));
            document.querySelectorAll(`.stream-card[data-channel-id="${id}"]`).forEach(c => c.classList.toggle('favorite', favoriteChannels.has(id)));
            applyFilter();
        }

        function showToast(message, isLive = false) {
            if ([...toastContainer.children].some(t => t.textContent.includes(message))) return;
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;bottom:80px;right:16px;background:#1E1E1E;color:#FFF;padding:16px 20px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.4);z-index:9999;max-width:90vw;border-left:5px solid ' + (isLive?'#E53935':'#00B7EB');
            toast.innerHTML = `<button style="position:absolute;top:6px;right:10px;background:none;border:none;color:#AAA;font-size:20px;cursor:pointer;" onclick="this.parentElement.remove()">x</button><div style="font-weight:bold;">${isLive?'配信開始！':'あと5分'}</div><div>${message}</div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 8000);
        }

        function checkNotifications() {
            if (!notifyEnabled) return;
            const now = Date.now();
            document.querySelectorAll('.stream-card').forEach(card => {
                const start = parseInt(card.dataset.startTime);
                const diff = start - now;
                const member = card.querySelector('.member-name').textContent;
                const title = card.querySelector('.stream-title').textContent;
                const isChecked = card.querySelector('.checkbox-overlay.checked');
                const isFavorite = favoriteChannels.has(card.dataset.channelId);
                if (!isChecked && !isFavorite) return;
                const message = `${member} - ${title}`;
                if (diff > -30000 && diff <= 30000 && !card.dataset.liveNotified) {
                    card.dataset.liveNotified = "true";
                    showToast(message, true);
                }
                if (diff > 240000 && diff <= 300000 && !card.dataset.fiveMinNotified) {
                    card.dataset.fiveMinNotified = "true";
                    showToast(message, false);
                }
            });
        }

        const notifyBtn = document.createElement('button');
        notifyBtn.id = 'notifyBtn';
        notifyBtn.textContent = `通知: ${notifyEnabled?'ON':'OFF'}`;
        notifyBtn.style.cssText = 'background:'+(notifyEnabled?'#FF9800':'#666')+';margin-left:10px;padding:8px 14px;border-radius:6px;color:white;';
        notifyBtn.onclick = () => {
            notifyEnabled = !notifyEnabled;
            notifyBtn.textContent = `通知: ${notifyEnabled?'ON':'OFF'}`;
            notifyBtn.style.background = notifyEnabled ? '#FF9800' : '#666';
            localStorage.setItem('notifyEnabled', notifyEnabled);
        };
        document.querySelector('.controls').appendChild(notifyBtn);

        setInterval(checkNotifications, 10000);

        window.onload = () => {
            loadSchedule();
            updateCheckedPanel();
            checkNotifications();
        };
    </script>
</body>
</html>
